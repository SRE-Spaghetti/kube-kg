# Story 2.2: Kubernetes Resource to Graph Mapping Logic

## Status
- Approved

## Story
**As a** developer,
**I want** a set of pure functions that can transform Kubernetes resource objects into a graph representation,
**so that** the data transformation logic is decoupled and easily testable.

## Acceptance Criteria
1. A function `KubernetesResourceToNode` is created that takes a KubeView resource object and returns a generic representation of a Neo4j node (label and properties).
2. A function `ExtractRelationships` is created that takes a KubeView resource object and returns a list of potential relationships (e.g., based on `ownerReferences`, label selectors, volume mounts).
3. The mapping logic correctly identifies the `uid` of a resource as the primary identifier for nodes.
4. The relationship extraction logic correctly identifies `ownerReferences` to link child resources to their parents (e.g., Pod to ReplicaSet).
5. The relationship extraction logic correctly identifies `Service` selectors and links them to `Pods` with matching labels.
6. Unit tests are written to verify the mapping and relationship extraction for all supported resource types (Pod, Deployment, Service, ConfigMap, Secret, ReplicaSet).

## Tasks / Subtasks
- [ ] Task 1: Define Graph Data Structures (AC: 1, 2)
  - [ ] Create a new package `internal/graph`.
  - [ ] In `internal/graph/mapper.go`, define structs to represent a generic `Node` and `Relationship`.
- [ ] Task 2: Implement Node Mapping Function (AC: 1, 3)
  - [ ] Implement the `KubernetesResourceToNode` function in `internal/graph/mapper.go`.
  - [ ] The function should extract the `uid`, `kind`, `name`, `namespace`, and other properties as defined in the data model.
- [ ] Task 3: Implement Relationship Extraction Function (AC: 2, 4, 5)
  - [ ] Implement the `ExtractRelationships` function in `internal/graph/mapper.go`.
  - [ ] Add logic to parse `ownerReferences` to create `OWNS` relationships.
  - [ ] Add logic to parse `service.spec.selector` and pod labels to create `SELECTS` relationships.
  - [ ] Add logic to parse pod volumes to create `MOUNTS` relationships to `ConfigMaps` and `Secrets`.
- [ ] Task 4: Write Unit Tests (AC: 6)
  - [ ] Create `internal/graph/mapper_test.go`.
  - [ ] Write comprehensive unit tests for `KubernetesResourceToNode` and `ExtractRelationships`.
  - [ ] Use test data from a `/testdata` directory to cover various resource types and relationship scenarios.

## Dev Notes

### File Locations & Structure
- `internal/graph/mapper.go` (New)
- `internal/graph/mapper_test.go` (New)

[Source: docs/architecture/09-source-tree.md]

### Data Models
- The implementation must adhere to the `KubernetesResource` node and relationship models defined in the architecture.
- **Primary Key:** `uid`
- **Node Label:** `kind`
- **Relationships:** `OWNS`, `SELECTS`, `MOUNTS`

[Source: docs/architecture/04-data-models.md]

### Coding Standards
- **Language:** Go 1.24.6
- **Style:** `gofmt`
- **No side-effects:** The mapping functions should be pure and have no side-effects.

[Source: docs/architecture/12-coding-standards.md]

### Testing
- **Unit Tests:** This story is focused on pure logic, so it should be covered entirely by unit tests.
- **Test Data:** Use JSON fixtures in a `/testdata` directory to represent KubeView resource objects.
- **Coverage:** 80% coverage is required.

[Source: docs/architecture/13-test-strategy-and-standards.md]

## Change Log

| Date       | Version | Description                | Author |
| :--------- | :------ | :------------------------- | :----- |
| 2025-09-18 | 1.0     | Initial draft of the story. | Bob    |
