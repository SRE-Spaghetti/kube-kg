# Story 2.1: KubeView API Client

## Status
- Approved

## Story
**As a** developer,
**I want** a client to interact with the KubeView REST API,
**so that** I can fetch the list of namespaces and all resources within them.

## Acceptance Criteria
1. A `KubeviewClient` struct is created with an `http.Client`.
2. Go structs are defined to accurately represent the JSON responses from `/api/namespaces` and `/api/fetch/{namespace}`, based on the `openapi.yaml`.
3. A `ListNamespaces` method is implemented that correctly calls the `/api/namespaces` endpoint and unmarshals the response.
4. A `FetchNamespaceResources` method is implemented that correctly calls the `/api/fetch/{namespace}` endpoint and unmarshals the response.
5. The client is instrumented with OpenTelemetry to trace the API calls.
6. Integration tests are written to verify the client can successfully connect to a KubeView instance and parse the responses.

## Tasks / Subtasks
- [ ] Task 1: Define KubeView API Data Structures (AC: 2)
  - [ ] Create a new package `internal/kubeview`.
  - [ ] In `internal/kubeview/client.go`, define Go structs for the `Namespace` and `Resource` objects based on the `openapi.yaml` and the data models.
- [ ] Task 2: Implement KubeView Client (AC: 1, 3, 4)
  - [ ] In `internal/kubeview/client.go`, define a `Client` struct that contains a configured `http.Client`.
  - [ ] Implement a `NewClient()` function that returns a `*Client`.
  - [ ] Implement the `ListNamespaces()` method.
  - [ ] Implement the `FetchNamespaceResources()` method.
- [ ] Task 3: Add OpenTelemetry Instrumentation (AC: 5)
  - [ ] Wrap the external HTTP calls in `ListNamespaces` and `FetchNamespaceResources` with OpenTelemetry spans.
- [ ] Task 4: Write Integration Tests (AC: 6)
  - [ ] Create `internal/kubeview/client_test.go`.
  - [ ] Write integration tests that use a mock HTTP server to test the client's functionality.
  - [ ] Verify that the client correctly unmarshals the JSON responses.

## Dev Notes

### File Locations & Structure
- `internal/kubeview/client.go` (New)
- `internal/kubeview/client_test.go` (New)

[Source: docs/architecture/09-source-tree.md]

### API Specification
- The client should conform to the OpenAPI spec defined in `openapi.yaml`. While the story does not require reading this file, the acceptance criteria are based on it.

[Source: docs/prd/epic-2-initial-graph-synchronization.md]

### Error Handling
- API errors from KubeView (e.g., 4xx, 5xx responses) should be wrapped in custom error types (e.g., `ErrKubeViewConnection`).
- Use a reasonable timeout on the `http.Client` (e.g., 30 seconds).

[Source: docs/architecture/11-error-handling-strategy.md]

### Coding Standards
- **Language:** Go 1.24.6
- **Context:** `context.Context` must be passed as the first argument to all methods that make network requests.
- **Logging:** Use `slog` for logging any important information or errors.

[Source: docs/architecture/12-coding-standards.md]

### Testing
- **Integration Tests:** Use a mock HTTP server to serve static JSON fixtures. Test data should be stored in a `/testdata` directory.
- **Framework:** Go `testing` package.

[Source: docs/architecture/13-test-strategy-and-standards.md]

## Change Log

| Date       | Version | Description                | Author |
| :--------- | :------ | :------------------------- | :----- |
| 2025-09-18 | 1.0     | Initial draft of the story. | Bob    |
