# Story 2.3: Initial Synchronization Processor

## Status
- Approved

## Story
**As a** developer,
**I want** a processor that orchestrates the full synchronization of Kubernetes resources into Neo4j,
**so that** I can populate the graph with the initial state of the cluster.

## Acceptance Criteria
1. An `InitialSync` function is created that takes the `KubeviewClient` and `Neo4jClient` as dependencies.
2. The function first calls the `KubeviewClient` to get all resources from all namespaces.
3. For each resource, it uses the mapping logic from Story 2.2 to generate nodes and relationships.
4. It then uses the `Neo4jClient` to execute idempotent `MERGE` queries to create/update the nodes and relationships in the database.
5. The entire synchronization process is wrapped in a single OpenTelemetry trace.
6. All Neo4j write operations for a given namespace are executed within a single transaction.
7. An integration test verifies that running `InitialSync` against a mock KubeView API correctly populates a test Neo4j database with the expected nodes and relationships.

## Tasks / Subtasks
- [ ] Task 1: Implement Initial Sync Function (AC: 1, 2, 3, 4)
  - [ ] Create a new package `internal/processor`.
  - [ ] In `internal/processor/processor.go`, implement the `InitialSync` function.
  - [ ] The function should loop through each namespace, fetch its resources, and then iterate through the resources to map them to nodes and relationships.
- [ ] Task 2: Add Transaction Management (AC: 6)
  - [ ] Ensure that all the `MERGE` queries for a single namespace are executed within a single Neo4j transaction.
- [ ] Task 3: Add OpenTelemetry Instrumentation (AC: 5)
  - [ ] Create a single parent span that covers the entire `InitialSync` operation.
- [ ] Task 4: Write Integration Tests (AC: 7)
  - [ ] Create `internal/processor/processor_test.go`.
  - [ ] Write an integration test that uses a mock KubeView client and a Testcontainers Neo4j instance.
  - [ ] The test should verify that the processor correctly fetches, maps, and persists the data.

## Dev Notes

### File Locations & Structure
- `internal/processor/processor.go` (New)
- `internal/processor/processor_test.go` (New)

[Source: docs/architecture/09-source-tree.md]

### Component Dependencies
- The `processor` component depends on the `kubeview`, `neo4j`, `graph`, and `observability` components.

[Source: docs/architecture/05-components.md]

### Data Consistency
- All Neo4j writes must use `MERGE` to ensure idempotency.
- Writes for a given namespace must be transactional.

[Source: docs/architecture/11-error-handling-strategy.md]

### Coding Standards
- **Language:** Go 1.24.6
- **Context:** `context.Context` must be passed to all functions that interact with external systems.

[Source: docs/architecture/12-coding-standards.md]

### Testing
- **Integration Tests:** This story requires an integration test that spins up a real Neo4j database using Testcontainers and mocks the KubeView API.
- **Test Data:** Use JSON fixtures for the mock KubeView API.

[Source: docs/architecture/13-test-strategy-and-standards.md]

## Change Log

| Date       | Version | Description                | Author |
| :--------- | :------ | :------------------------- | :----- |
| 2025-09-18 | 1.0     | Initial draft of the story. | Bob    |
