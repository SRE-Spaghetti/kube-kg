# Story 4.2: Main Service Orchestration

## Status
- Ready for Review

## Story
**As a** developer,
**I want** a main entrypoint that correctly initializes and manages the lifecycle of all service components,
**so that** the service starts, runs, and stops reliably.

## Acceptance Criteria
1. The `main.go` file contains the main application entrypoint.
2. The `main` function orchestrates the startup sequence:
    - Load configuration (from Story 1.1).
    - Initialize OpenTelemetry (from Story 1.2).
    - Create the `Neo4jClient` and `KubeviewClient` (from Stories 1.3 and 2.1).
    - Start the `InitialSync` process in a goroutine (from Story 2.3).
    - Start the KubeView SSE stream and the event processor in separate goroutines (from Epic 3).
    - Start the internal HTTP server (from Story 4.1).
3. The application listens for OS signals (`SIGINT`, `SIGTERM`) to trigger a graceful shutdown.
4. Upon receiving a shutdown signal, the application cleanly closes the KubeView and Neo4j client connections and stops the HTTP server.
5. An end-to-end test plan is documented in the README, describing how to run the service and verify its core functionality (e.g., check for nodes in Neo4j, call the health endpoint).

## Tasks / Subtasks
- [x] Task 1: Implement Main Function (AC: 1, 2)
  - [x] In `cmd/kube-kg/main.go`, implement the `main` function.
  - [x] Add calls to initialize all the components in the correct order as specified in the AC.
  - [x] Start the long-running processes (sync, event processor, API server) in separate goroutines.
- [x] Task 2: Implement Graceful Shutdown (AC: 3, 4)
  - [x] Add signal handling to the `main` function to listen for `SIGINT` and `SIGTERM`.
  - [x] Upon receiving a signal, call the `Close()` methods on the clients and gracefully shut down the HTTP server.
- [x] Task 3: Document End-to-End Test Plan (AC: 5)
  - [x] Update the `README.md` with a section for End-to-End testing.
  - [x] The plan should describe the steps to run the service and verify its functionality manually.

## Dev Notes

### File Locations & Structure
- `cmd/kube-kg/main.go` (Modified)
- `README.md` (Modified)

[Source: docs/architecture/09-source-tree.md]

### Component Dependencies
- The `main` function will depend on all other components in the application.

[Source: docs/architecture/05-components.md]

### Coding Standards
- **No `init()` functions:** All initialization must be explicit in `main`.
- **No global variables:** All state should be managed and passed as dependencies.

[Source: docs/architecture/12-coding-standards.md]

### Testing
- This story is primarily about orchestration and will be tested manually via the E2E test plan.

[Source: docs/architecture/13-test-strategy-and-standards.md]

## Dev Agent Record

- **Agent Model Used**: Gemini
- **Debug Log References**:
  - Corrected multiple compilation errors due to missing imports and incorrect function calls.
  - Resolved syntax errors caused by a file corruption by using `write_file` to restore the content.
  - Diagnosed the final runtime error as a missing `NEO4J_URI` environment variable.
- **Completion Notes**:
  - Implemented the main application entrypoint in `cmd/kube-kg/main.go`.
  - The implementation includes service orchestration for all background processes (initial sync, event processing) and the HTTP server.
  - Graceful shutdown on `SIGINT` or `SIGTERM` is implemented.
  - Added a comprehensive End-to-End test plan to `README.md`.
- **File List**:
  - `cmd/kube-kg/main.go` (modified)
  - `README.md` (modified)

## Change Log

| Date       | Version | Description                | Author |
| :--------- | :------ | :------------------------- | :----- |
| 2025-10-06 | 1.1     | Implemented main orchestration and graceful shutdown. | James (Gemini) |
| 2025-09-18 | 1.0     | Initial draft of the story. | Bob    |
