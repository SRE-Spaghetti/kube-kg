# Story 1.3: Neo4j Client Implementation

## Status
- Approved

## Story
**As a** developer,
**I want** a dedicated Neo4j client wrapper,
**so that** I can interact with the database in a consistent and testable manner.

## Acceptance Criteria
1. A `Neo4jClient` struct is created that encapsulates the official Neo4j Go driver.
2. A `NewNeo4jClient` function correctly initializes a connection to the database using the loaded configuration.
3. A `Close` method is implemented to gracefully shut down the database connection.
4. A generic `RunCypher` method is implemented that can execute a given Cypher query with parameters against the database.
5. Integration tests are written to verify that the client can successfully connect to a Neo4j instance and execute a basic query (e.g., `RETURN 1`).
6. The application, upon startup, successfully connects to the Neo4j database using the client.

## Tasks / Subtasks
- [ ] Task 1: Add Neo4j Driver Dependency (AC: 1)
  - [ ] Add the official Neo4j Go driver (`github.com/neo4j/neo4j-go-driver/v5`) to `go.mod`.
- [ ] Task 2: Implement Neo4j Client (AC: 1, 2, 3, 4)
  - [ ] Create a new package `internal/neo4j`.
  - [ ] In `internal/neo4j/client.go`, define a `Client` struct that wraps the `neo4j.DriverWithContext`.
  - [ ] Implement a `NewClient()` function that takes the application config and returns a new `*Client`, handling the connection logic.
  - [ ] Implement a `Close()` method on the `Client` struct.
  - [ ] Implement a `RunCypher()` method that executes a query within a session.
- [ ] Task 3: Write Integration Tests (AC: 5)
  - [ ] Create `internal/neo4j/client_test.go`.
  - [ ] Use the `testcontainers-go` library to spin up a Neo4j container for testing.
  - [ ] Write a test to verify a successful connection.
  - [ ] Write a test for the `RunCypher` method to ensure it can execute a query.
- [ ] Task 4: Integrate into Main Application (AC: 6)
  - [ ] In `cmd/kube-kg/main.go`, call `neo4j.NewClient()` during startup.
  - [ ] Ensure the `Close()` method is called during graceful shutdown.

## Dev Notes

### File Locations & Structure
- `internal/neo4j/client.go` (New)
- `internal/neo4j/client_test.go` (New)
- `cmd/kube-kg/main.go` (Modified)

[Source: docs/architecture/09-source-tree.md]

### Technology Stack
- **DB Driver:** neo4j-go-driver 5.15.0

[Source: docs/architecture/03-tech-stack.md]

### Error Handling
- Errors returned from the Neo4j driver must be wrapped with context using `fmt.Errorf`.
- Connection logic should handle potential errors gracefully.

[Source: docs/architecture/11-error-handling-strategy.md]

### Coding Standards
- **Language:** Go 1.24.6
- **Formatting:** `gofmt`
- **Linting:** `golangci-lint`
- **Context:** `context.Context` must be passed as the first argument to all I/O methods.

[Source: docs/architecture/12-coding-standards.md]

### Testing
- **Integration Tests:** Use Testcontainers to create a real Neo4j instance for tests.
- **Framework:** Go `testing` package.
- **File Convention:** `_test.go`.

[Source: docs/architecture/13-test-strategy-and-standards.md]

## Change Log

| Date       | Version | Description                | Author |
| :--------- | :------ | :------------------------- | :----- |
| 2025-09-18 | 1.0     | Initial draft of the story. | Bob    |
