# Story 4.1: Internal REST API

## Status
- Approved

## Story
**As an** operator,
**I want** an HTTP API to check the health of the service and trigger a manual refresh,
**so that** I can monitor the service and manage its state.

## Acceptance Criteria
1. An HTTP server is started using the standard `net/http` package.
2. A `HealthHandler` is implemented for the `/health` endpoint.
3. The health handler checks connectivity to both KubeView and Neo4j and returns `200 OK` only if both are reachable, otherwise it returns `503 Service Unavailable`.
4. A `RefreshHandler` is implemented for the `/refresh` endpoint.
5. The refresh handler triggers the `InitialSync` function (from Epic 2) in a new goroutine to avoid blocking the request.
6. The refresh handler immediately returns a `202 Accepted` status code.
7. Integration tests are written to verify the behavior of both the `/health` and `/refresh` endpoints.

## Tasks / Subtasks
- [ ] Task 1: Implement HTTP Server (AC: 1)
  - [ ] Create a new package `internal/api`.
  - [ ] In `internal/api/server.go`, implement a `NewServer` function that sets up an `http.Server` with handlers for the `/health` and `/refresh` endpoints.
- [ ] Task 2: Implement Health Handler (AC: 2, 3)
  - [ ] Implement the `HealthHandler`.
  - [ ] This handler should have dependencies on the `KubeviewClient` and `Neo4jClient` to check their status.
  - [ ] It should return the correct HTTP status code and a JSON body as specified in the OpenAPI spec.
- [ ] Task 3: Implement Refresh Handler (AC: 4, 5, 6)
  - [ ] Implement the `RefreshHandler`.
  - [ ] This handler will have a dependency on the `processor` component to call the `InitialSync` function.
  - [ ] The `InitialSync` function must be called in a new goroutine.
- [ ] Task 4: Write Integration Tests (AC: 7)
  - [ ] Create `internal/api/server_test.go`.
  - [ ] Write integration tests for both handlers, mocking the client and processor dependencies.
  - [ ] Verify the HTTP status codes and response bodies.

## Dev Notes

### File Locations & Structure
- `internal/api/server.go` (New)
- `internal/api/server_test.go` (New)

[Source: docs/architecture/09-source-tree.md]

### API Specification
- The API must conform to the OpenAPI specification in `docs/architecture/07-rest-api-spec.md`.

[Source: docs/architecture/07-rest-api-spec.md]

### Component Dependencies
- The `api` component depends on the `processor`, `kubeview`, and `neo4j` components.

[Source: docs/architecture/05-components.md]

### Coding Standards
- **Language:** Go 1.24.6
- **API:** Use the standard `net/http` library.

[Source: docs/architecture/12-coding-standards.md]

### Testing
- **Integration Tests:** Mock the dependencies of the API handlers to test the API logic in isolation.
- **Framework:** Go `testing` package and `net/http/httptest`.

[Source: docs/architecture/13-test-strategy-and-standards.md]

## Change Log

| Date       | Version | Description                | Author |
| :--------- | :------ | :------------------------- | :----- |
| 2025-09-18 | 1.0     | Initial draft of the story. | Bob    |
