# Story 3.1: KubeView SSE Client

## Status
- Approved

## Story
**As a** developer,
**I want** a client that can connect to the KubeView SSE stream and parse incoming events,
**so that** I can receive real-time updates about Kubernetes resource changes.

## Acceptance Criteria
1. A function `StreamUpdates` is implemented that connects to the `/updates?clientID={id}` endpoint.
2. The function correctly reads the `text/event-stream` format, parsing `event:` and `data:` lines.
3. The `data` JSON is successfully unmarshaled into a `kubeview.Event` struct.
4. Parsed events are sent to a Go channel for consumption by the event processor.
5. `ping` events are handled correctly to maintain the connection without being sent to the event channel.
6. The client includes a retry mechanism with backoff to automatically reconnect if the connection is lost.
7. An integration test verifies that the client can connect to a mock SSE stream, parse events, and send them to the channel.

## Tasks / Subtasks
- [ ] Task 1: Add SSE Client Dependency (AC: 1)
  - [ ] Add the `r3labs/sse/v2` library to `go.mod`.
- [ ] Task 2: Implement SSE Event Structure (AC: 3)
  - [ ] In `internal/kubeview/client.go`, define an `Event` struct to represent the SSE data payload.
- [ ] Task 3: Implement StreamUpdates Function (AC: 1, 2, 4, 5, 6)
  - [ ] In `internal/kubeview/client.go`, implement the `StreamUpdates` function on the `Client` struct.
  - [ ] This function should use the `sse` library to connect to the `/updates` endpoint.
  - [ ] It should parse incoming events, unmarshal the data, and send valid events to a channel.
  - [ ] Implement a retry loop with exponential backoff for connection errors.
- [ ] Task 4: Write Integration Tests (AC: 7)
  - [ ] In `internal/kubeview/client_test.go`, add integration tests for `StreamUpdates`.
  - [ ] Use a mock HTTP server that simulates an SSE stream, including `ping` events and connection drops.

## Dev Notes

### File Locations & Structure
- `internal/kubeview/client.go` (Modified)
- `internal/kubeview/client_test.go` (Modified)

[Source: docs/architecture/09-source-tree.md]

### Technology Stack
- **SSE Client:** r3labs/sse/v2 2.0.2

[Source: docs/architecture/03-tech-stack.md]

### Error Handling
- The client must implement a retry policy with exponential backoff for connection errors to the SSE stream.
- Connection errors should be logged using `slog`.

[Source: docs/architecture/11-error-handling-strategy.md]

### Coding Standards
- **Language:** Go 1.24.6
- **Context:** `context.Context` must be used to manage the lifecycle of the streaming connection.

[Source: docs/architecture/12-coding-standards.md]

### Testing
- **Integration Tests:** Use a mock HTTP server to provide a test SSE stream.
- **Test Scenarios:** Tests should cover successful event parsing, handling of ping events, and connection recovery after a drop.

[Source: docs/architecture/13-test-strategy-and-standards.md]

## Change Log

| Date       | Version | Description                | Author |
| :--------- | :------ | :------------------------- | :----- |
| 2025-09-18 | 1.0     | Initial draft of the story. | Bob    |
